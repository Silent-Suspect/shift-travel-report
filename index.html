<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Fahrtbericht Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- STYLES --- */
    :root { 
        --bg: #121212; --card: #1e1e1e; --text: #fff; 
        --accent: #3498db; --border: #333; 
        --success: #2ecc71; --danger: #e74c3c; --warn: #f39c12; 
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 15px; max-width: 800px; margin: 0 auto; padding-bottom: 80px;}
    
    input, button, textarea { width: 100%; padding: 12px; margin-top: 3px; border-radius: 8px; border: 1px solid #444; background: #000; color: white; box-sizing: border-box; font-family: sans-serif; }
    input:focus, textarea:focus { border-color: var(--accent); outline: none; }
    
    .card { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 100px; } 
    .hidden { display: none !important; }
    
    .btn-primary { background: var(--accent); border: none; font-weight: bold; cursor: pointer; color: white; margin-top:10px; font-size: 1.1rem; padding: 15px; }
    /* btn-load entfernt, da nicht mehr ben√∂tigt */
    .btn-nav { background: #333; border: 1px solid #555; font-size: 0.9rem; cursor: pointer; }
    .btn-nav:hover { background: #444; }

    #offline-banner { background: var(--danger); color: white; text-align: center; padding: 10px; font-weight: bold; border-radius: 8px; margin-bottom: 15px; display: none; }
    
    .station-chain { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .station-wrapper { display: flex; align-items: center; }
    .station-input { width: 90px !important; text-transform: uppercase; text-align: center; font-weight: bold; letter-spacing: 1px; }
    .arrow { color: var(--accent); font-size: 1.2rem; margin: 0 5px; }
    
    .segment-card { border-left: 4px solid var(--accent); margin-top: 15px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 0 8px 8px 0; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .seg-header { font-size: 0.95rem; font-weight: bold; color: var(--accent); margin-bottom: 8px; display: flex; justify-content: space-between; }
    .inp-mini { font-size: 0.9rem; padding: 8px; }
    
    .lbl-mini { 
        font-size: 0.7rem; 
        color: #888; 
        margin-left: 2px; 
        text-transform: uppercase; 
        font-weight: bold; 
        letter-spacing: 0.5px; 
        white-space: normal; 
        display: block; 
        margin-top: 15px;
        margin-bottom: 2px; 
        line-height: 1.1;
    }
    
    .check-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
    input[type="checkbox"] { width: auto; margin-right: 15px; transform: scale(1.3); cursor: pointer; }
    .sub-field { margin-top: 10px; padding-left: 15px; border-left: 2px solid var(--accent); }
    
    .sub-label { font-weight: bold; color: #aaa; align-self: center; min-width: 110px;}

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    #api-pw { width: 100px; text-align: center; font-size: 0.8rem; border-color: var(--accent); }

    /* CONFLICT MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-content { background: var(--card); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--warn); }
    .conflict-item { background: #000; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #333; }
    .conflict-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
    .val-box { padding: 8px; margin: 2px 0; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
    .val-server { background: rgba(52, 152, 219, 0.2); color: #aaa; } 
    .val-draft { background: rgba(46, 204, 113, 0.2); color: #fff; font-weight: bold; }
    .val-box.selected { border-color: var(--success); background: rgba(46, 204, 113, 0.4); }
    .val-box:not(.selected) { opacity: 0.6; }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-server { background: #555; } .btn-draft { background: var(--success); }
  </style>
</head>
<body>

<header>
    <h4 style="color:var(--accent); margin:0;">Fahrtbericht V9.0</h4>
    <input type="password" id="api-pw" placeholder="PW" required>
</header>

<div id="offline-banner">‚ö†Ô∏è OFFLINE MODUS</div>

<div class="card">
    <div class="row">
        <div class="col">
            <label class="lbl-mini">DATUM</label>
            <input type="date" id="datum">
        </div>
    </div>
    
    <div id="nav-buttons" class="row hidden" style="margin-top:10px;">
        <div class="col"><button type="button" class="btn-nav" onclick="changeDay(-1)">‚óÄ VORHERIGER</button></div>
        <div class="col"><button type="button" class="btn-nav" onclick="changeDay(1)">N√ÑCHSTER ‚ñ∂</button></div>
    </div>
    <div id="file-status" style="margin-top: 10px; font-size: 0.85rem; color: #aaa; text-align: center;"></div>
</div>

<div id="editor-area" class="hidden">
    
    <div class="card">
        <label style="color:var(--accent); font-weight:bold;">1. STRECKE</label>
        <div class="station-chain" id="station-container"></div>
    </div>

    <div class="card">
        <label style="color:var(--accent); font-weight:bold;">2. ZUG DETAILS</label>
        <div id="segments-container"></div>
        <div id="segments-msg" style="color:#666; font-style:italic; margin-top:10px;">Gib oben mindestens 2 Stationen ein.</div>
    </div>

    <div class="card">
        <label style="color:var(--accent); font-weight:bold;">3. SCHICHT & Z√ÑHLER</label>
        
        <div style="margin-top:15px; padding-bottom:5px; border-bottom:1px solid #444;">
            <div class="row" style="align-items: center;">
                <div class="sub-label">DIENSTBEGINN</div>
                <div class="col"><input type="time" id="beginn"></div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label class="lbl-mini">Kilometerstand</label>
                <input type="number" id="km_start" placeholder="Start">
            </div>
            <div class="col">
                <label class="lbl-mini">EZ (Aufn.) 1.8</label>
                <input type="number" step="any" id="nrg18_start" placeholder="kWh">
            </div>
            <div class="col">
                <label class="lbl-mini">EZ (R√ºcksp.) 2.8</label>
                <input type="number" step="any" id="nrg28_start" placeholder="kWh">
            </div>
        </div>

        <div style="margin-top:25px; padding-bottom:5px; border-bottom:1px solid #444;">
            <div class="row" style="align-items: center;">
                <div class="sub-label">DIENSTENDE</div>
                <div class="col"><input type="time" id="ende"></div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label class="lbl-mini">Kilometerstand</label>
                <input type="number" id="km_ende" placeholder="Ende">
            </div>
            <div class="col">
                <label class="lbl-mini">EZ (Aufn.) 1.8</label>
                <input type="number" step="any" id="nrg18_ende" placeholder="kWh">
            </div>
            <div class="col">
                <label class="lbl-mini">EZ (R√ºcksp.) 2.8</label>
                <input type="number" step="any" id="nrg28_ende" placeholder="kWh">
            </div>
        </div>
    </div>

    <div class="card">
        <label style="color:var(--accent); font-weight:bold;">4. STATUS</label>
        <div class="check-row"><input type="checkbox" id="c_str" onchange="toggleBox('sub_str', this.checked)"><label for="c_str">Streckenkunde / EW / BR</label></div>
        <div id="sub_str" class="hidden sub-field"><input type="text" id="val_streckenkunde" placeholder="Info"></div>
        <div class="check-row"><input type="checkbox" id="c_vor"><label for="c_vor">Ausfall vor DB</label></div>
        <div class="check-row"><input type="checkbox" id="c_nach"><label for="c_nach">Ausfall nach DB</label></div>
        <div class="check-row"><input type="checkbox" id="c_normal"><label for="c_normal">Normaldienst</label></div>
        <div class="check-row"><input type="checkbox" id="c_bereit"><label for="c_bereit">Bereitschaft</label></div>
        <div class="check-row" style="border-top:1px solid #444; margin-top:5px;"><input type="checkbox" id="c_versch" onchange="toggleBox('sub_versch', this.checked)"><label for="c_versch">Dienst verschoben</label></div>
        <div id="sub_versch" class="hidden sub-field"><input type="number" step="0.1" id="val_verschiebung" placeholder="Stunden"></div>
    </div>

    <div class="card">
        <label style="color:var(--accent); font-weight:bold;">5. SONSTIGE BEMERKUNGEN</label>
        <div style="font-size:0.75rem; color:#888; margin-bottom:5px; line-height: 1.3;">
            Sonstige Hinweise, Lokzustand, St√∂rungen, M√§ngel an Fahrzeugen, Fehlende Fahrplanunterlagen, Dienstplanw√ºnsche, etc.
        </div>
        <textarea id="manual_notes" rows="3" placeholder="Hier tippen..."></textarea>
    </div>

    <button id="btnSave" class="btn-primary" onclick="saveData()">SPEICHERN</button>
    <div id="statusbox" style="margin-top:15px; text-align:center;"></div>
</div>

<div id="conflict-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">‚ö†Ô∏è Konflikte erkannt</div>
        <div style="font-size:0.9rem; color:#ccc; margin-bottom:15px;">
            Unterschiede zwischen Server und deinem lokalen Entwurf. W√§hle was du behalten willst.
        </div>
        <div id="conflict-list"></div>
        <div class="modal-actions">
            <button class="btn-server" onclick="resolveAll('server')">Alle vom Server</button>
            <button class="btn-draft" onclick="resolveAll('draft')">Alle vom Entwurf</button>
        </div>
        <button onclick="applyResolution()" style="margin-top:10px; background:var(--accent);">Auswahl √ºbernehmen</button>
    </div>
</div>

<script>
    // --- DEINE URL EINF√úGEN ---
    const API_URL = "https://script.google.com/macros/s/AKfycbw1pMOyQJBEQulcNO_vuDonoipHF0SdYFZrRYaacnB6JO0UoEHFpTkUK-JnoNhhkRd9/exec"; 

    // STATE
    let currentFileId = null; 
    let unsavedChanges = false;
    let isLoading = false; 
    let isOfflineMode = false;
    let pendingMergeData = null;

    document.addEventListener("DOMContentLoaded", () => {
        try {
            document.getElementById('datum').valueAsDate = new Date();
            const savedPW = localStorage.getItem("app_password");
            if(savedPW) document.getElementById('api-pw').value = savedPW;
            document.getElementById('api-pw').addEventListener("input", function() { localStorage.setItem("app_password", this.value); });
            
            addStationInput(); addStationInput();
            attachDirtyListeners();
            const noteBox = document.getElementById('manual_notes');
            if (noteBox) noteBox.addEventListener('input', markDirty);
            checkDraftAvailability(document.getElementById('datum').value);
        } catch (e) { alert("Fehler beim App-Start: " + e); }
    });

    document.getElementById('datum').addEventListener('change', (e) => {
        if (unsavedChanges && !confirm("‚ö†Ô∏è Ungespeicherte √Ñnderungen!\nWirklich Datum wechseln?")) return;
        resetStatusUI(); checkDraftAvailability(e.target.value); attemptLoad();
    });

    function resetStatusUI() {
        document.getElementById('statusbox').innerHTML = "";
        const btn = document.getElementById('btnSave'); btn.innerText = "SPEICHERN"; btn.disabled = false;
    }

    function changeDay(offset) {
        if (unsavedChanges && !confirm("‚ö†Ô∏è Ungespeicherte √Ñnderungen!\nWirklich Tag wechseln?")) return;
        const dateInput = document.getElementById('datum'); if(!dateInput.value) return;
        const d = dateInput.valueAsDate; d.setDate(d.getDate() + offset); dateInput.valueAsDate = d;
        resetStatusUI(); checkDraftAvailability(dateInput.value); attemptLoad();
    }

    function checkDraftAvailability(date) {
        const draft = localStorage.getItem("draft_" + date); const status = document.getElementById('file-status');
        if(draft) status.innerHTML = `<span style="color:var(--warn)">Lokaler Entwurf vorhanden.</span>`; else status.innerHTML = "";
    }
    function autoSaveToLocal() {
        const date = document.getElementById('datum').value;
        localStorage.setItem("draft_" + date, JSON.stringify(collectFormData()));
    }
    window.toggleBox = function(id, show) { const el = document.getElementById(id); if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); markDirty(); }
    function markDirty() { if(!isLoading) { unsavedChanges = true; autoSaveToLocal(); } }
    function attachDirtyListeners() {
        document.querySelectorAll('#editor-area input').forEach(el => {
            if(!el.dataset.watched) { el.addEventListener('input', markDirty); el.addEventListener('change', markDirty); el.dataset.watched = "true"; }
        });
    }

    function collectFormData() {
        const segments = [];
        document.querySelectorAll('.segment-card:not(.hidden)').forEach(c => {
            segments.push({
                start: c.querySelector('.inp-start').value, ziel: c.querySelector('.inp-ziel').value,
                zugNr: c.querySelector('.inp-zug').value, tfz: c.querySelector('.inp-tfz').value,
                ab: c.querySelector('.inp-ab').value, an: c.querySelector('.inp-an').value, note: c.querySelector('.inp-note').value
            });
        });
        const noteEl = document.getElementById('manual_notes');
        return {
            password: document.getElementById('api-pw').value, fileId: currentFileId, datum: document.getElementById('datum').value,
            
            beginn: document.getElementById('beginn').value, 
            km_start: document.getElementById('km_start').value,
            nrg18_start: document.getElementById('nrg18_start').value,
            nrg28_start: document.getElementById('nrg28_start').value,

            ende: document.getElementById('ende').value,
            km_ende: document.getElementById('km_ende').value,
            nrg18_ende: document.getElementById('nrg18_ende').value,
            nrg28_ende: document.getElementById('nrg28_ende').value,

            chk_streckenkunde: document.getElementById('c_str').checked, val_streckenkunde: document.getElementById('val_streckenkunde').value,
            chk_ausfall_vor: document.getElementById('c_vor').checked, chk_ausfall_nach: document.getElementById('c_nach').checked,
            chk_normal: document.getElementById('c_normal').checked, chk_bereitschaft: document.getElementById('c_bereit').checked,
            val_verschiebung: document.getElementById('c_versch').checked ? document.getElementById('val_verschiebung').value : "",
            manual_notes: noteEl ? noteEl.value : "",
            segments: segments, stations: Array.from(document.querySelectorAll('.station-input')).map(i=>i.value).filter(v=>v)
        };
    }

    function addStationInput(val = "") {
        const cont = document.getElementById('station-container');
        if (cont.children.length > 0) { const arrow = document.createElement('span'); arrow.className = 'arrow'; arrow.innerHTML = '‚ûû'; cont.appendChild(arrow); }
        const wrap = document.createElement('div'); wrap.className = 'station-wrapper';
        const inp = document.createElement('input'); inp.type = 'text'; inp.className = 'station-input'; inp.placeholder = 'CODE'; inp.value = val;
        inp.addEventListener('input', checkStationInputs); inp.addEventListener('input', markDirty);
        wrap.appendChild(inp); cont.appendChild(wrap);
    }
    function checkStationInputs(e) {
        const inputs = Array.from(document.querySelectorAll('.station-input'));
        if (inputs[inputs.length - 1].value.trim() !== "" && inputs.length < 6) addStationInput();
        updateSegments();
    }
    function updateSegments() {
        const inputs = Array.from(document.querySelectorAll('.station-input'));
        const codes = inputs.map(i => i.value.trim().toUpperCase()).filter(v => v !== "");
        const cont = document.getElementById('segments-container');
        const msg = document.getElementById('segments-msg');
        if (codes.length < 2) { msg.classList.remove('hidden'); Array.from(cont.children).forEach(c => c.classList.add('hidden')); return; }
        msg.classList.add('hidden');
        for (let i = 0; i < codes.length - 1; i++) {
            if (i >= 5) break; 
            const start = codes[i]; const ziel = codes[i+1]; const segId = `segment-${i}`; let card = document.getElementById(segId);
            if (!card) {
                card = document.createElement('div'); card.id = segId; card.className = 'segment-card';
                card.innerHTML = `<div class="seg-header"><span>ZUG ${i+1}: <span class="route-label">${start} ‚ûû ${ziel}</span></span></div><div class="row"><div class="col"><label class="lbl-mini">ZUG-NR</label><input type="text" class="inp-mini inp-zug" placeholder="12345"></div><div class="col"><label class="lbl-mini">TFZ-NR</label><input type="text" class="inp-mini inp-tfz" placeholder="403..."></div></div><div class="row"><div class="col"><label class="lbl-mini">AB</label><input type="time" class="inp-mini inp-ab"></div><div class="col"><label class="lbl-mini">AN</label><input type="time" class="inp-mini inp-an"></div></div><input type="text" class="inp-mini inp-note" style="margin-top:8px;" placeholder="Bemerkungen"><input type="hidden" class="inp-start" value="${start}"><input type="hidden" class="inp-ziel" value="${ziel}">`;
                cont.appendChild(card); card.querySelectorAll('input').forEach(el => el.addEventListener('input', markDirty));
            } else {
                card.classList.remove('hidden'); card.querySelector('.route-label').innerText = `${start} ‚ûû ${ziel}`; card.querySelector('.inp-start').value = start; card.querySelector('.inp-ziel').value = ziel;
            }
        }
        const allCards = cont.querySelectorAll('.segment-card');
        allCards.forEach((c, idx) => { if (idx >= (codes.length - 1)) c.classList.add('hidden'); });
    }

    async function callAPI(payload) {
        const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 30000);
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload), signal: controller.signal });
        clearTimeout(timeoutId); return await response.json();
    }

    async function attemptLoad() {
        const pw = document.getElementById('api-pw').value;
        const date = document.getElementById('datum').value;
        // btnLoad entfernt
        const status = document.getElementById('file-status');
        const banner = document.getElementById('offline-banner');
        
        if(!pw) { alert("Passwort fehlt!"); return; }
        // Loading Status zeigen
        isLoading = true; status.innerHTML = "‚è≥ Lade Daten...";
        
        try {
            const res = await callAPI({ action: "load", password: pw, date: date });
            isOfflineMode = false; banner.style.display = "none";
            document.getElementById('editor-area').classList.remove('hidden');
            document.getElementById('nav-buttons').classList.remove('hidden'); 
            
            if (res.success) {
                const localDraftJson = localStorage.getItem("draft_" + date);
                if (localDraftJson && res.found) {
                    const localDraft = JSON.parse(localDraftJson);
                    const conflicts = compareDatasets(res.data, localDraft);
                    if (conflicts.length === 0) {
                        status.innerHTML = `<span style="color:#2ecc71">Geladen. Entwurf war identisch.</span>`;
                        currentFileId = res.fileId; fillForm(res.data); localStorage.removeItem("draft_" + date);
                    } else {
                        status.innerHTML = `<span style="color:var(--warn)">Konflikte erkannt!</span>`;
                        currentFileId = res.fileId; pendingMergeData = { server: res.data, draft: localDraft, conflicts: conflicts };
                        showConflictModal(conflicts); fillForm(res.data);
                    }
                } else if (res.found) {
                    status.innerHTML = `<span style="color:#2ecc71">Bericht geladen.</span>`;
                    currentFileId = res.fileId; fillForm(res.data);
                } else if (localDraftJson) {
                     status.innerHTML = `<span style="color:var(--warn)">Neu (Nur lokaler Entwurf).</span>`;
                     loadFromLocal(localDraftJson);
                } else {
                    status.innerHTML = "Neuer Bericht."; currentFileId = null; resetForm(); 
                }
            } else {
                alert("API Fehler: " + res.error);
                status.innerHTML = `<span style="color:var(--danger)">Fehler beim Laden</span>`;
            }
        } catch(e) {
            isOfflineMode = true; banner.style.display = "block";
            document.getElementById('editor-area').classList.remove('hidden');
            document.getElementById('nav-buttons').classList.remove('hidden'); 
            const localDraft = localStorage.getItem("draft_" + date);
            if(localDraft) { status.innerHTML = "Offline. Entwurf geladen."; loadFromLocal(localDraft); }
            else { status.innerHTML = "Offline. Neu."; currentFileId = null; resetForm(); }
        }
        
        setTimeout(() => { isLoading = false; unsavedChanges = false; }, 100);
    }

    function compareDatasets(server, draft) {
        const diffs = [];
        const check = (label, key, isBool = false) => {
            const sVal = server[key] || (isBool ? false : "");
            const dVal = draft[key] || (isBool ? false : "");
            if (String(sVal) !== String(dVal)) { if(!sVal && !dVal) return; diffs.push({ label: label, key: key, server: sVal, draft: dVal, isSeg: false }); }
        };
        // ALTE FELDER
        check("Dienstbeginn", "beginn"); check("Dienstende", "ende");
        
        // NEUE FELDER
        check("KM Start", "km_start"); check("Energie 1.8 Start", "nrg18_start"); check("Energie 2.8 Start", "nrg28_start");
        check("KM Ende", "km_ende"); check("Energie 1.8 Ende", "nrg18_ende"); check("Energie 2.8 Ende", "nrg28_ende");

        check("Streckenkunde", "chk_streckenkunde", true); check("Info Streckenkunde", "val_streckenkunde");
        check("Ausfall vor", "chk_ausfall_vor", true); check("Ausfall nach", "chk_ausfall_nach", true);
        check("Normaldienst", "chk_normal", true); check("Bereitschaft", "chk_bereitschaft", true);
        check("Verschiebung", "val_verschiebung"); check("Sonstige Bemerkungen", "manual_notes"); 

        const maxLen = Math.max(server.segments?.length || 0, draft.segments?.length || 0);
        for(let i=0; i<maxLen; i++) {
            const sSeg = server.segments?.[i] || {};
            const dSeg = draft.segments?.[i] || {};
            const subCheck = (name, f) => {
                if (String(sSeg[f]||"") !== String(dSeg[f]||"")) {
                    diffs.push({ label: `Zug ${i+1}: ${name}`, key: `seg_${i}_${f}`, server: sSeg[f]||"(leer)", draft: dSeg[f]||"(leer)", isSeg: true, idx: i, field: f });
                }
            };
            subCheck("Zug-Nr", "zugNr"); subCheck("Tfz", "tfz"); subCheck("Abfahrt", "ab"); subCheck("Ankunft", "an"); subCheck("Notiz", "note");
        }
        return diffs;
    }

    function showConflictModal(conflicts) {
        const list = document.getElementById('conflict-list'); list.innerHTML = "";
        conflicts.forEach((c, idx) => {
            const div = document.createElement('div'); div.className = "conflict-item";
            const showVal = (v) => v === true ? "‚òë JA" : (v === false ? "‚òê NEIN" : v);
            div.innerHTML = `<div class="conflict-label">${c.label}</div><div class="val-box val-server" id="conf-s-${idx}" onclick="selectResolution(${idx}, 'server')"><span>SERVER: <b>${showVal(c.server)}</b></span></div><div class="val-box val-draft selected" id="conf-d-${idx}" onclick="selectResolution(${idx}, 'draft')"><span>ENTWURF: <b>${showVal(c.draft)}</b></span></div>`;
            list.appendChild(div);
        });
        document.getElementById('conflict-modal').classList.remove('hidden');
    }

    window.selectResolution = function(idx, choice) { document.getElementById(`conf-s-${idx}`).classList.remove('selected'); document.getElementById(`conf-d-${idx}`).classList.remove('selected'); document.getElementById(`conf-${choice.charAt(0)}-${idx}`).classList.add('selected'); }
    window.resolveAll = function(choice) { document.querySelectorAll('.val-box').forEach(b => b.classList.remove('selected')); const targetClass = choice === 'server' ? '.val-server' : '.val-draft'; document.querySelectorAll(targetClass).forEach(b => b.classList.add('selected')); }
    window.applyResolution = function() {
        const conflicts = pendingMergeData.conflicts; const mergedData = JSON.parse(JSON.stringify(pendingMergeData.server));
        if(!mergedData.segments) mergedData.segments = [];
        conflicts.forEach((c, idx) => {
            if (document.getElementById(`conf-d-${idx}`).classList.contains('selected')) {
                if (!c.isSeg) mergedData[c.key] = pendingMergeData.draft[c.key];
                else { if(!mergedData.segments[c.idx]) mergedData.segments[c.idx] = {}; mergedData.segments[c.idx][c.field] = pendingMergeData.draft.segments?.[c.idx]?.[c.field]; }
            }
        });
        fillForm(mergedData); document.getElementById('conflict-modal').classList.add('hidden'); document.getElementById('file-status').innerHTML = `<span style="color:var(--success)">Konflikte gel√∂st.</span>`; unsavedChanges = true; 
    }

    function loadFromLocal(jsonStr) { const data = JSON.parse(jsonStr); currentFileId = data.fileId; fillForm(data); }
    function fillForm(data) {
        document.getElementById('station-container').innerHTML = ''; document.getElementById('segments-container').innerHTML = ''; 
        
        document.getElementById('beginn').value = data.beginn; 
        document.getElementById('km_start').value = data.km_start || "";
        document.getElementById('nrg18_start').value = data.nrg18_start || "";
        document.getElementById('nrg28_start').value = data.nrg28_start || "";

        document.getElementById('ende').value = data.ende;
        document.getElementById('km_ende').value = data.km_ende || "";
        document.getElementById('nrg18_ende').value = data.nrg18_ende || "";
        document.getElementById('nrg28_ende').value = data.nrg28_ende || "";

        const setC = (id, checked, subId) => { document.getElementById(id).checked = checked; if(subId) { const sub = document.getElementById(subId); if(checked) sub.classList.remove('hidden'); else sub.classList.add('hidden'); } };
        setC('c_str', data.chk_streckenkunde, 'sub_str'); document.getElementById('val_streckenkunde').value = data.val_streckenkunde;
        setC('c_vor', data.chk_ausfall_vor); setC('c_nach', data.chk_ausfall_nach); setC('c_normal', data.chk_normal); setC('c_bereit', data.chk_bereitschaft);
        if(data.val_verschiebung) { setC('c_versch', true, 'sub_versch'); document.getElementById('val_verschiebung').value = data.val_verschiebung; } else { setC('c_versch', false, 'sub_versch'); }
        
        const noteEl = document.getElementById('manual_notes'); if(noteEl) noteEl.value = data.manual_notes || "";
        const segs = data.segments || []; const stations = [];
        if(data.stations && data.stations.length > 0) data.stations.forEach(st => stations.push(st)); else if (segs.length > 0) { stations.push(segs[0].start); segs.forEach(s => stations.push(s.ziel)); } else { stations.push('', ''); }
        stations.forEach(st => addStationInput(st)); if(stations.length < 6) addStationInput();
        updateSegments();
        segs.forEach((s, i) => { const card = document.getElementById(`segment-${i}`); if(card) { card.querySelector('.inp-zug').value = s.zugNr; card.querySelector('.inp-tfz').value = s.tfz; card.querySelector('.inp-ab').value = s.ab; card.querySelector('.inp-an').value = s.an; card.querySelector('.inp-note').value = s.note; } });
        attachDirtyListeners();
    }

    function resetForm() {
        document.getElementById('station-container').innerHTML = ''; document.getElementById('segments-container').innerHTML = ''; 
        addStationInput(); addStationInput(); 
        
        // RESET ALL INPUTS
        document.getElementById('beginn').value = ''; document.getElementById('ende').value = '';
        document.getElementById('km_start').value = ''; document.getElementById('km_ende').value = '';
        document.getElementById('nrg18_start').value = ''; document.getElementById('nrg18_ende').value = '';
        document.getElementById('nrg28_start').value = ''; document.getElementById('nrg28_ende').value = '';

        const noteEl = document.getElementById('manual_notes'); if(noteEl) noteEl.value = '';
        document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
        document.querySelectorAll('.sub-field').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('input:not([type="button"]):not([type="submit"]):not([type="checkbox"]):not([type="radio"]):not([type="date"]):not([type="password"])').forEach(i => i.value = '');
        attachDirtyListeners();
    }

    async function saveData() {
        const btn = document.getElementById('btnSave'); const status = document.getElementById('statusbox'); const date = document.getElementById('datum').value;
        btn.disabled = true; btn.innerText = "SPEICHERE..."; autoSaveToLocal(); 
        if (isOfflineMode) { btn.disabled = false; btn.innerText = "LOKAL GESICHERT üíæ"; status.innerHTML = `<span style="color:var(--warn)">Daten auf Handy gespeichert.<br>Sende sie, wenn du Internet hast!</span>`; unsavedChanges = false; return; }
        const data = collectFormData(); data.action = "save"; 
        try {
            const res = await callAPI(data);
            if (res.success) { btn.disabled = false; btn.innerText = "GESPEICHERT ‚úÖ"; status.innerHTML = `<div style="margin-top:10px;">‚úÖ <b>Erfolg!</b><br><a href="${res.excelUrl}" target="_blank" style="color:var(--success); font-weight:bold; border:1px solid var(--success); padding:5px 10px; border-radius:5px; text-decoration:none;">üì§ EXCEL LADEN</a></div>`; unsavedChanges = false; localStorage.removeItem("draft_" + date); } 
            else { btn.disabled = false; btn.innerText = "FEHLER"; status.innerHTML = `<span style="color:var(--danger)">${res.error}</span>`; }
        } catch(e) { isOfflineMode = true; document.getElementById('offline-banner').style.display = "block"; btn.disabled = false; btn.innerText = "LOKAL GESICHERT üíæ"; status.innerHTML = `<span style="color:var(--danger)">Verbindung verloren.<br>Daten lokal gesichert.</span>`; unsavedChanges = false; }
    }
</script>

</body>
</html>
